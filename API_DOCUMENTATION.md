# Mahjong Score Tracker REST API Documentation

## Overview
The Mahjong Score Tracker provides a REST API for submitting, updating, and deleting session scores programmatically.

**Authentication:** All API endpoints require bearer token authentication. Tokens can only be generated by Django administrators.

**Base URL:** `https://your-domain.com/api/`

---

## Authentication

### Obtaining an API Token
1. Log in to the Django admin panel at `/admin/`
2. Navigate to **Users** or **Tokens** section
3. Find your user account (must be a team admin)
4. Generate or view your API token
5. Use this token in the `Authorization` header for all API requests

### Using the Token
Include the token in the `Authorization` header:

```http
Authorization: Bearer your-token-here
```

---

## API Endpoints

### 1. Validate Token

**Endpoint:** `GET /api/validate-token/`

**Description:** Validate that the provided bearer token is valid and active. Returns user information and associated teams if token is valid.

**Request Headers:**
```http
Authorization: Bearer your-token-here
```

**Success Response (200 OK):**
```json
{
  "valid": true,
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com"
  },
  "teams": [
    {
      "id": 1,
      "name": "Team Alpha",
      "slug": "team-alpha"
    },
    {
      "id": 2,
      "name": "Team Beta",
      "slug": "team-beta"
    }
  ]
}
```

**Error Response (401 Unauthorized):**
```json
{
  "detail": "Invalid token."
}
```

**Use Cases:**
- Verify token is still valid before making data requests
- Get list of teams the authenticated user can manage
- Health check for API integrations

---

### 2. Submit New Session

**Endpoint:** `POST /api/teams/{team_slug}/sessions/`

**Description:** Submit a new session with exactly 4 scores.

**Request Headers:**
```http
Authorization: Bearer your-token-here
Content-Type: application/json
```

**Request Body:**
```json
{
  "session_id": "2024-12-23-evening",
  "session_date": "2024-12-23",
  "scores": [
    {"member_name": "Alice", "score": 35000, "chombo": false},
    {"member_name": "Bob", "score": 30000, "chombo": false},
    {"member_name": "Charlie", "score": 25000, "chombo": false},
    {"member_name": "Diana", "score": 10000, "chombo": true}
  ]
}
```

**Parameters:**
- `session_id` (string, required): Unique identifier for the session
- `session_date` (string, optional): Date in YYYY-MM-DD format
- `scores` (array, required): Array of exactly 4 score objects
  - `member_name` (string, required): Name of the member (must exist in team)
  - `score` (integer, required): Raw Mahjong score
  - `chombo` (boolean, optional): Whether player went bankrupt (default: false)

**Success Response (201 Created):**
```json
{
  "success": true,
  "message": "Session 2024-12-23-evening scores submitted successfully",
  "session_id": "2024-12-23-evening",
  "scores_created": 4
}
```

**Error Responses:**

*400 Bad Request - Invalid data:*
```json
{
  "scores": ["Exactly 4 scores are required for a session, got 3"]
}
```

*403 Forbidden - Not team admin:*
```json
{
  "error": "You do not have permission to submit scores for this team."
}
```

*409 Conflict - Session already exists:*
```json
{
  "error": "Session 2024-12-23-evening already exists. Use PUT to update.",
  "existing_scores": 4
}
```

---

### 3. Update Existing Session

**Endpoint:** `PUT /api/teams/{team_slug}/sessions/{session_id}/`

**Description:** Update all scores for an existing session.

**Request Headers:**
```http
Authorization: Bearer your-token-here
Content-Type: application/json
```

**Request Body:** (same as POST)
```json
{
  "session_id": "2024-12-23-evening",
  "session_date": "2024-12-23",
  "scores": [
    {"member_name": "Alice", "score": 36000, "chombo": false},
    {"member_name": "Bob", "score": 29000, "chombo": false},
    {"member_name": "Charlie", "score": 26000, "chombo": false},
    {"member_name": "Diana", "score": 9000, "chombo": true}
  ]
}
```

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "Session 2024-12-23-evening updated successfully",
  "session_id": "2024-12-23-evening",
  "scores_updated": 4
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "Session 2024-12-23-evening does not exist. Use POST to create."
}
```

---

### 4. Delete Session

**Endpoint:** `DELETE /api/teams/{team_slug}/sessions/{session_id}/delete/`

**Description:** Delete an existing session and all its scores.

**Request Headers:**
```http
Authorization: Bearer your-token-here
```

**Success Response (200 OK):**
```json
{
  "success": true,
  "message": "Session 2024-12-23-evening deleted successfully",
  "scores_deleted": 4
}
```

**Error Response (404 Not Found):**
```json
{
  "error": "Session 2024-12-23-evening does not exist."
}
```

---

## Example Usage

### Python Example
```python
import requests

API_BASE_URL = "https://your-domain.com/api"
TOKEN = "your-token-here"

headers = {
    "Authorization": f"Bearer {TOKEN}",
    "Content-Type": "application/json"
}

# Validate token first
validate_response = requests.get(
    f"{API_BASE_URL}/validate-token/",
    headers=headers
)

if validate_response.status_code == 200:
    data = validate_response.json()
    print(f"Token valid for user: {data['user']['username']}")
    print(f"Manages {len(data['teams'])} team(s)")
else:
    print("Invalid token!")
    exit(1)

# Submit new session
payload = {
    "session_id": "2024-12-23-evening",
    "session_date": "2024-12-23",
    "scores": [
        {"member_name": "Alice", "score": 35000, "chombo": False},
        {"member_name": "Bob", "score": 30000, "chombo": False},
        {"member_name": "Charlie", "score": 25000, "chombo": False},
        {"member_name": "Diana", "score": 10000, "chombo": True}
    ]
}

response = requests.post(
    f"{API_BASE_URL}/teams/my-team/sessions/",
    headers=headers,
    json=payload
)

print(response.json())
```

### cURL Example
```bash
curl -X POST https://your-domain.com/api/teams/my-team/sessions/ \
  -H "Authorization: Bearer your-token-here" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "2024-12-23-evening",
    "session_date": "2024-12-23",
    "scores": [
      {"member_name": "Alice", "score": 35000, "chombo": false},
      {"member_name": "Bob", "score": 30000, "chombo": false},
      {"member_name": "Charlie", "score": 25000, "chombo": false},
      {"member_name": "Diana", "score": 10000, "chombo": true}
    ]
  }'
```

---

## Validation Rules

1. **Exactly 4 scores** must be submitted per session
2. **Each member can only appear once** per session
3. **Member must belong to the specified team**
4. **Session ID must be unique** within a team (for POST requests)
5. **Score values** must be integers
6. **Chombo flag** is optional (defaults to false)
7. **Session date** is optional but recommended for historical accuracy

---

## Security Notes

- API tokens are equivalent to passwords - keep them secure
- Tokens grant full access to submit/update/delete scores for your team
- Only Django administrators can generate tokens
- Tokens can be regenerated by deleting and creating a new one in the admin panel
- Each user can have only one active token at a time

---

## Rate Limiting

Currently, there is no rate limiting implemented. Please use the API responsibly.

---

## Support

For issues or questions, contact the system administrator or refer to the project documentation.
